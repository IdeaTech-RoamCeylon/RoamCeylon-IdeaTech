# AI Quality Metrics

> Status: Describes the quality rules for the locked AI Trip Planner v1.0.0  
> Sources: `planner.constants.ts`, `ai.controller.ts`, `search.service.ts`, `embedding.service.ts`

---

## 1. Relevance Score & Confidence Thresholds

**Score range**

- All relevance scores are in the range **0.0 – 1.0**:
  - In `/ai/search`: from cosine similarity (`EmbeddingService.cosineSimilarity`).
  - In vector search: from normalized pgvector distance (`SearchService.normalizeScore`).

**Confidence labels (`SearchService.getConfidence`)**

- `High`: **score ≥ 0.80**
- `Medium`: **0.50 ≤ score < 0.80**
- `Low`: **score < 0.50**

**Planner cut‑offs (`PLANNER_CONFIG.CONFIDENCE`)**

- `HIGH`: `0.80`
- `MEDIUM`: `0.50`
- `MINIMUM`: `0.55` → **minimum usable score for itinerary planning**

**Operational buckets**

- `high_relevance`:  
  - `score ≥ 0.80`  
  - Label: `High` confidence  
  - Used directly in plans and marked as strong matches.
- `medium_relevance`:  
  - `0.55 ≤ score < 0.80`  
  - Label: `Medium` confidence  
  - Eligible for trip planning (passes `MINIMUM` filter).
- `low_relevance`:  
  - `0.30 ≤ score < 0.55`  
  - Can appear in **vector search/debug** (via `getConfidenceThreshold('Low') = 0.30`),  
    but scores `< 0.55` are **not** used for itinerary planning.
- `reject`:  
  - `score < 0.30`  
  - Considered too weak and excluded from results.

Explain in UI / docs:

- Where scores come from (cosine similarity / pgvector retrieval).
- That **trip plans** only use items with `score ≥ 0.55`.

---

## 2. Consistency Checks

### Data / Content Consistency

- **Destination / region gating**
  - Activities are **strongly gated** by destination using `gateByNearOrRegion`:
    - Keep if:
      - destination appears in `Near:` metadata, **or**
      - item `Region:` matches computed destination region, **or**
      - destination is mentioned directly in the text.
    - If this would drop **all** items, we **fall back** to the original set to avoid an empty plan.
- **Duplicates**
  - Vector results are de‑duplicated by `id` in `SearchService`.
  - Additional text‑level de‑duplication is applied when selecting diverse activities.
- **Per day activities** (`PLANNER_CONFIG.ACTIVITIES`)
  - 1‑day trips: **max 2** activities (`MAX_PER_DAY_SHORT`).
  - Trips with 2+ days: **max 4** activities per day (`MAX_PER_DAY_LONG`).
- **Total activities per trip**
  - Hard cap: **≤ 15** activities per trip (`MAX_TOTAL`).

### Logic Consistency

- **Dates / days**
  - `dayCount` = days between `startDate` and `endDate` (inclusive).
  - Number of `dayByDayPlan` entries **must equal** `dayCount`.
  - Each day’s `date` is computed as `startDate + (day - 1)`.
- **Time slots order**
  - Time slots are assigned chronologically by `assignTimeSlot`:
    - Day 1: **Afternoon → Evening** (arrival‑friendly).
    - Other days: **Morning → Afternoon → Evening** spread across activities.
- **Fallback behavior**
  - If no items pass the `MINIMUM` confidence or content checks, a **structured fallback itinerary** is generated:
    - Day 1: `Arrival` theme, afternoon slot.
    - Other days: `Sightseeing` / exploration with safe defaults.

---

## 3. Explanation Clarity Rules

Every activity **generated by the planner** includes a `RichExplanation` (see `buildRichExplanation`):

- **Selection reason**
  - 1‑line, human‑readable summary: why this place was chosen.
- **Ranking factors**
  - `relevanceScore` (0.0–1.0, also shown as a percentage, e.g. `82%`).
  - `confidenceLevel`: `High` / `Medium` / `Low`.
  - `categoryMatch`: whether it fits the chosen itinerary category.
  - `preferenceMatch`:  
    - When user preferences are provided, list of matched preferences.  
    - If no preferences are provided, this may be omitted.
  - `novelty`: `High` / `Medium` / `Low` to avoid repetitive picks.

- **Why this place**
  - Bullets explaining:
    - Match strength label (e.g. “Excellent match (87%)”).
    - Whether it’s a very strong/strong/decent/variety pick.
    - Any detected match to preferences or categories.
    - If the region seems far from the destination, a clear note is added.

- **Why this day**
  - Arrival‑friendly logic for Day 1.
  - Final‑day wrap‑up notes for the last day.
  - Mid‑trip balancing (energy, type of activities).

- **Why this time slot**
  - Morning: daylight / higher energy.
  - Afternoon: balance after morning activity.
  - Evening: relaxed finish.
  - Day‑1 arrival: explicit afternoon/evening logic.

- **Tips**
  - Practical, non‑technical advice (e.g., sun protection, comfortable shoes, extra time).

**Fallback / low‑confidence explanations**

- Fallback activities clearly state they are **fallback recommendations**:
  - E.g. “Fallback recommendation: not enough high‑confidence matches…”
- They include tips like:
  - “Add 1–2 preferences (e.g., ‘beach’, ‘history’) or nearby town names for stronger matches.”
- Non‑fallback low‑confidence items are described as:
  - “Lower‑confidence option; included mainly for variety.”

---

## 4. How We’ll Use These Metrics (Later)

Implementation guidance (some already present, some planned):

- **Backend**
  - Enforce relevance thresholds:
    - Drop items below `PLANNER_CONFIG.CONFIDENCE.MINIMUM (0.55)` for planning.
  - Use `assessResultQuality` in `SearchService` to label result sets as:
    - `Excellent`, `Good`, `Fair`, or `Poor`.
  - Log:
    - Average score per search.
    - How often fallback itineraries are used.
    - How many activities are filtered out by confidence / content checks.

- **Frontend**
  - Optionally surface a simple quality label per trip or per search:
    - `Excellent` / `Good` / `Fair` / `Poor`.
  - Show user‑friendly messages from the backend:
    - E.g. “Results have low confidence scores. Try more specific keywords.”